!function(window,angular,undefined){"use strict";angular.module("mallzee.ui-table-view",[]).directive("mlzUiTableView",["$window","$timeout","$log",function($window,$timeout,$log){return{restrict:"E",transclude:!0,replace:!1,template:'<div class="mlz-ui-table-view-wrapper" ng-transclude></div>',link:function(scope,element,attributes){function initialise(scope,attributes){_scroll=angular.copy(scroll),_view=angular.copy(view),_buffer=angular.copy(buffer),attributes.rowHeight&&(row.height=+attributes.rowHeight),attributes.columns&&(columns=+attributes.columns),attributes.rows&&(buffer.rows=+attributes.rows,buffer.size=buffer.rows*columns),attributes.triggerTop&&(triggerTop=function(){scope.$eval(attributes.triggerTop)}),attributes.triggerBottom&&(triggerBottom=function(){scope.$eval(attributes.triggerBottom)}),calculateContainer(),list.length>0&&(container.el.prop("scrollTop",getYFromIndex(buffer.top)),updateBuffer())}function updateBuffer(){calculateDimensions(),createBuffer(),positionElements()}function scrollToTop(){container.el.animate({scrollTop:0},"slow")}function getYFromIndex(index){return index*row.height}function createBuffer(){if(!list)return!1;angular.copy(list.slice(itemIndexFromRow(buffer.top),itemIndexFromRow(buffer.bottom)),items);for(var i=0;i<items.length;i++)items[i].$$position=i;drawBuffer(),setupNextTick()}function drawBuffer(){if(list.length<=0||items.length<=0)return!1;for(var p,x,y,el,e,r=buffer.top-1,i=0;i<buffer.size;i++)e=itemIndexFromRow(buffer.top)+i,p=getRelativeBufferPosition(e),p%columns===0?r++:null,x=p%columns*(container.width/columns),y=r*row.height,el=angular.element(elements[p]),e>=list.length?hideElement(p):showElement(p),angular.extend(items[p],list[e]),items[p].$$index=e,items[p].$$height=row.height,items[p].$$top=y,items[p].$$visible=!1,renderElement(p,x,y),i<view.rows&&(items[i].$$visible=!0);calculateWrapper()}function setScrollPosition(x,y){if(y===undefined&&(y=x),updateScrollModel(y),updateViewModel(),buffer.reset||buffer.refresh)switch(scroll.direction){case SCROLL_UP:setBufferToIndex(view.bottom-buffer.size);break;case SCROLL_DOWN:setBufferToIndex(view.top)}updateBufferModel(),render(),isTriggerRequired()&&triggerEdge(),setupNextTick()}function getRelativeBufferPosition(index){return index%buffer.size}function itemIndexFromRow(row){return row*columns}function setupNextTick(){angular.extend(_scroll,scroll),angular.extend(_view,view),angular.extend(_buffer,buffer)}function positionElements(){elements.length>0||$timeout(function(){elements=container.el.children().children(),container.el.prop("scrollTop",getYFromIndex(buffer.top));for(var p,x,y,el,r=buffer.top-1,i=itemIndexFromRow(buffer.top);i<itemIndexFromRow(buffer.top)+buffer.size;i++)p=getRelativeBufferPosition(i),p%columns===0?r++:null,x=p%columns*(container.width/columns),y=r*row.height,el=angular.element(elements[p]),console.log("Positioning elements",buffer.top,p,x,y),el.css({position:"absolute",height:row.height+"px",webkitTransform:"translate3d("+x+"px, "+y+"px, 0px)"})})}function validateBuffer(){buffer.top<0?(buffer.top=0,buffer.bottom=buffer.rows):buffer.bottom>=list.length&&(buffer.top=wrapper.rows-buffer.rows,buffer.bottom=wrapper.rows),buffer.yTop=buffer.top*row.height,buffer.yBottom=buffer.bottom*row.height,buffer.atEdge=buffer.top<=0?EDGE_TOP:buffer.bottom>=wrapper.rows?EDGE_BOTTOM:!1}function isRenderRequired(){return scroll.direction===SCROLL_UP&&buffer.atEdge!==EDGE_TOP&&view.deadZone===!1&&(scroll.directionChange||view.ytChange)||scroll.direction===SCROLL_DOWN&&buffer.atEdge!==EDGE_BOTTOM&&view.deadZone===!1&&(scroll.directionChange||view.ytChange)||!(view.deadZone!==!1&&view.deadZoneChange===!1)}function isTriggerRequired(){return view.triggerZone!==!1&&view.triggerZoneChange}function updateScrollModel(y){scroll.y=y,scroll.yDelta=y-_scroll.y,scroll.row=Math.floor(y/row.height),scroll.row<0&&(scroll.row=0),scroll.row>=wrapper.rows&&(scroll.row=wrapper.rows-1),scroll.yDistance=Math.abs(scroll.row-_scroll.row),scroll.yChange=scroll.yDistance>0,scroll.direction=scroll.yDelta>=0?SCROLL_DOWN:SCROLL_UP,scroll.directionChange=scroll.direction!==_scroll.direction,buffer.reset=scroll.yDistance>buffer.rows}function updateViewModel(){view.yTop=scroll.y,view.yBottom=scroll.y+container.height,view.top=scroll.row,view.bottom=Math.floor(view.yBottom/row.height),view.atEdge=!(view.top>0&&view.bottom<list.length-1),view.triggerZone=view.yTop<trigger.distance*row.height?EDGE_TOP:view.yBottom>(list.length-trigger.distance-1)*row.height?EDGE_BOTTOM:!1,view.triggerZoneChange=view.triggerZone!==_view.triggerZone,view.deadZone=view.yTop<row.height?EDGE_TOP:view.yBottom>(list.length-1)*row.height?EDGE_BOTTOM:!1,view.deadZoneChange=view.deadZone!==_view.deadZone,view.ytChange=view.top!==_view.top,view.ybChange=view.bottom!==_view.bottom}function setBufferToIndex(index){buffer.top=index,buffer.bottom=buffer.top+buffer.rows,validateBuffer()}function updateBufferModel(){var index=scroll.row,direction=scroll.direction,distance=buffer.distance;switch(direction){case SCROLL_UP:buffer.top=index-distance,buffer.bottom=index-distance+buffer.rows;break;case SCROLL_DOWN:buffer.top=index,buffer.bottom=index+buffer.rows;break;default:$log.warn("We only know how to deal with scrolling on the y axis for now")}validateBuffer()}function scrollingUp(start,distance){for(var p,x,y,itemsToMerge=list.slice(start*columns,start*columns+distance),r=start+distance/columns-1,i=itemsToMerge.length-1;i>=0;i--)p=getRelativeBufferPosition(start*columns+i),x=p%columns*(container.width/columns),y=r*row.height,itemsToMerge[i].$$top=y,itemsToMerge[i].$$index=start*columns+i,angular.extend(items[p],itemsToMerge[i]),renderElement(p,x,y),p%columns===0?r--:null}function scrollingDown(start,distance){for(var p,x,y,itemsToMerge=list.slice(start*columns,start*columns+distance),r=start-1,i=0;i<itemsToMerge.length;i++)p=getRelativeBufferPosition(start*columns+i),p%columns===0?r++:null,x=p%columns*(container.width/columns),y=r*row.height,itemsToMerge[i].$$top=y,itemsToMerge[i].$$index=start*columns+i,angular.extend(items[p],itemsToMerge[i]),renderElement(p,x,y)}function render(){var start,end,distance;if(isRenderRequired())if(buffer.reset||buffer.refresh)switch(start=buffer.top,end=buffer.bottom,distance=(end-start)*columns,scroll.direction){case SCROLL_UP:scrollingUp(start,distance);break;case SCROLL_DOWN:scrollingDown(start,distance)}else switch(scroll.direction){case SCROLL_UP:start=buffer.top,end=_buffer.top,distance=Math.abs((end-start)*columns),scrollingUp(start,distance);break;case SCROLL_DOWN:start=_buffer.bottom,end=buffer.bottom,distance=Math.abs((end-start)*columns),scrollingDown(start,distance)}}function renderElement(index,x,y){var element=angular.element(elements[index]);element.css("-webkit-transform","translate3d("+x+"px, "+y+"px, 0px)")}function hideElement(index){var element=angular.element(elements[index]);element.css("visibility","hidden")}function showElement(index){angular.element(elements[index]);elements.css("visibility","normal")}function triggerEdge(){switch(view.triggerZone){case EDGE_TOP:triggerTop();break;case EDGE_BOTTOM:triggerBottom();break;default:$log.warn("Zone "+view.triggerZone+" is not supported")}}function triggerTop(){}function triggerBottom(){}function calculateDimensions(){calculateWrapper(),calculateBuffer()}function calculateContainer(){container.height=container.el.prop("clientHeight"),container.width=container.el.prop("clientWidth")}function calculateWrapper(){list&&(wrapper.rows=(list.length+list.length%columns)/columns,wrapper.height=wrapper.rows*row.height,wrapper.el.css("height",wrapper.height+"px"))}function calculateBuffer(){view.rows=Math.ceil(container.height/row.height)+1,buffer.bottom=buffer.top+buffer.rows||buffer.top+BUFFER_SIZE,buffer.yBottom=buffer.bottom*row.height||(buffer.top+BUFFER_SIZE)*ROW_HEIGHT,buffer.distance=buffer.rows-view.rows>0?buffer.rows-view.rows:0}function cleanup(){$window.removeEventListener("statusTap"),container.el.off("scroll"),scope.$destory()}var elements,_scroll,_view,_buffer,BUFFER_ROWS=10,COLUMNS=1,ROW_HEIGHT=40,ROW_WIDTH="100%",EDGE_TOP="top",EDGE_BOTTOM="bottom",SCROLL_UP="up",SCROLL_DOWN="down",TRIGGER_DISTANCE=5,list=[],items=[],container={height:0,width:0,el:undefined},wrapper={height:0,width:0,rows:0,el:undefined},row={height:ROW_HEIGHT,width:ROW_WIDTH},columns=COLUMNS,trigger={distance:TRIGGER_DISTANCE},scroll={x:0,xDelta:0,xIndex:0,xDistance:0,xChange:!1,y:0,yDelta:0,yDistance:0,yChange:!1,row:0,pointer:0,direction:SCROLL_DOWN,directionChange:!1},view={top:0,bottom:0,left:0,right:0,items:[],size:0,rows:0,yTop:0,yBottom:0,atEdge:EDGE_TOP,deadZone:EDGE_TOP,deadZoneChange:!1},buffer={rows:BUFFER_ROWS,size:BUFFER_ROWS*COLUMNS,items:[],elements:[],top:0,bottom:0,left:0,right:0,yTop:0,yBottom:0,atEdge:EDGE_TOP,pointer:0,distance:0,reset:!1,refresh:!1};container.el=element,wrapper.el=element.children(),elements=element.children().children(),list=scope.$eval(attributes.list),scope.items=items,scope.deleteItem=function(){buffer.atEdge===EDGE_BOTTOM&&(buffer.top--,buffer.bottom--),updateBuffer()},wrapper.el.css("position","relative"),initialise(scope,attributes),scope.$watchCollection("list",function(newList){console.log("List changed"),newList?list=newList:$log.warn("Trying to remove the list completely"),list.length>0&&updateBuffer()}),$window.addEventListener("statusTap",function(){scrollToTop()}),container.el.on("scroll",function(){scope.$apply(function(){setScrollPosition(container.el.prop("scrollTop"))})}),element.on("$destory",function(){cleanup()})}}}])}(window,window.angular);