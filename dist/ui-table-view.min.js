!function(window,angular,undefined){"use strict";function getBlockElements(nodes){var startNode=nodes[0],endNode=nodes[nodes.length-1];if(startNode===endNode)return angular.element(startNode);var element=startNode,elements=[element];do{if(element=element.nextSibling,!element)break;elements.push(element)}while(element!==endNode);return angular.element(elements)}angular.module("mallzee.ui-table-view",["ngAnimate"]).directive("mlzUiTableViewItem",function(){return{restrict:"A",link:function(scope,element){scope.$watch("$coords",function(coords){console.log("Item coords has changed",coords),coords&&element.css({position:"absolute",webkitTransform:"translate3d("+coords.x+"px, "+coords.y+"px, 0px)"})})}}}).directive("mlzUiTableView",["$window","$timeout","$log","$animate","$$animateReflow",function($window,$timeout,$log,$animate,$$animateReflow){return{restrict:"E",transclude:!0,terminal:!0,priority:1e4,$$tlb:!0,replace:!1,template:'<div class="mlz-ui-table-view-wrapper" ng-transclude></div>',link:function(scope,element,attributes,ctrl,$transclude){function tick(){updating||$$animateReflow(function(){update()}),updating=!0}function update(){updating=!1,setScrollPosition(y)}function initialise(scope,attributes){element.css({display:"block",overflow:"hidden"}),_scroll=angular.copy(scroll),_view=angular.copy(view),_buffer=angular.copy(buffer),attributes.itemName&&(itemName=scope.$eval(attributes.itemName)),attributes.viewParams&&scope.$watch(attributes.viewParams,function(view){console.log("View params change",view),row.height=view.rowHeight?view.rowHeight:ROW_HEIGHT,columns=view.columns?view.columns:COLUMNS,buffer.rows=view.rows?view.rows:BUFFER_ROWS,buffer.size=buffer.rows*columns,refresh()},!0),attributes.triggerTop&&(triggerTop=function(){scope.$eval(attributes.triggerTop)}),attributes.triggerBottom&&(triggerBottom=function(){scope.$eval(attributes.triggerBottom)}),$window.addEventListener("statusTap",function(){scrollToTop()}),calculateContainer()}function refresh(){container.el.prop("scrollTop",getYFromIndex(buffer.top)),generateBufferedItems(),calculateDimensions(),iscroll.refresh()}function cloneElement(clone){clone[clone.length++]=document.createComment(" end mlzTableViewItem: "+attributes.list+" "),$animate.enter(clone,wrapper.el)}function updateItem(elIndex,item,coords,index){buffer.elements[elIndex].scope[itemName]=item,buffer.elements[elIndex].scope.$coords=coords,buffer.elements[elIndex].scope.$index=index,$animate.move(buffer.elements[elIndex].clone,wrapper.el)}function destroyItem(index){var elementsToRemove=getBlockElements(buffer.elements[index].clone);$animate.leave(elementsToRemove),buffer.elements[index].scope.$destroy(),buffer.elements.splice(index,1)}function generateBufferedItems(){if(angular.copy(list.slice(itemIndexFromRow(buffer.top),itemIndexFromRow(buffer.bottom)),items),list.length<=0||items.length<=0)return!1;if(buffer.elements.length>buffer.size){console.log("We need to destroy some shit!",buffer.elements.length,buffer.size);for(var elementsLength=buffer.elements.length,i=elementsLength-1;i>=buffer.size;i--)console.log("Destroying ",i,elementsLength),destroyItem(i)}else{var p,x,y,e,r=buffer.top-1;console.log("Buffer deets",buffer.elements.length,buffer.size);for(var i=buffer.elements.length;i<buffer.size;i++)if(items&&i>items.length)destroyItem(i);else{e=itemIndexFromRow(buffer.top)+i,p=getRelativeBufferPosition(e),p%columns===0?r++:null,x=p%columns*(container.width/columns),y=r*row.height;var newItem={};newItem.scope=scope.$new(),newItem.scope[itemName]=list[e],newItem.scope.$index=e,newItem.scope.$height=row.height,newItem.scope.$coords={x:x,y:y},newItem.scope.$visible=!1,newItem.clone=$transclude(newItem.scope,cloneElement),buffer.elements[i]=newItem}}calculateWrapper(),setupNextTick()}function scrollToTop(){iscroll.scrollTo(0,0,1e3,IScroll.utils.ease.elastic)}function getYFromIndex(index){return index*row.height}function setScrollPosition(x,y){if(y===undefined&&(y=x),updateScrollModel(y),updateViewModel(),buffer.reset||buffer.refresh)switch(scroll.direction){case SCROLL_UP:setBufferToIndex(view.bottom-buffer.size);break;case SCROLL_DOWN:setBufferToIndex(view.top)}updateBufferModel(),render(),isTriggerRequired()&&triggerEdge(),setupNextTick()}function getRelativeBufferPosition(index){return index%buffer.size}function itemIndexFromRow(row){return row*columns}function setupNextTick(){angular.extend(_scroll,scroll),angular.extend(_view,view),angular.extend(_buffer,buffer)}function validateBuffer(){buffer.top<0?(buffer.top=0,buffer.bottom=buffer.rows):buffer.bottom>=list.length&&(buffer.top=wrapper.rows-buffer.rows,buffer.bottom=wrapper.rows),buffer.yTop=buffer.top*row.height,buffer.yBottom=buffer.bottom*row.height,buffer.atEdge=buffer.top<=0?EDGE_TOP:buffer.bottom>=wrapper.rows?EDGE_BOTTOM:!1}function isRenderRequired(){return scroll.direction===SCROLL_UP&&buffer.atEdge!==EDGE_TOP&&view.deadZone===!1&&(scroll.directionChange||view.ytChange)||scroll.direction===SCROLL_DOWN&&buffer.atEdge!==EDGE_BOTTOM&&view.deadZone===!1&&(scroll.directionChange||view.ytChange)||!(view.deadZone!==!1&&view.deadZoneChange===!1)}function isTriggerRequired(){return view.triggerZone!==!1&&view.triggerZoneChange}function updateScrollModel(y){scroll.y=y,scroll.yDelta=y-_scroll.y,scroll.row=Math.floor(y/row.height),scroll.row<0&&(scroll.row=0),scroll.row>=wrapper.rows&&(scroll.row=wrapper.rows-1),scroll.yDistance=Math.abs(scroll.row-_scroll.row),scroll.yChange=scroll.yDistance>0,scroll.direction=scroll.yDelta>=0?SCROLL_DOWN:SCROLL_UP,scroll.directionChange=scroll.direction!==_scroll.direction,buffer.reset=scroll.yDistance>buffer.rows}function updateViewModel(){view.yTop=scroll.y,view.yBottom=scroll.y+container.height,view.top=scroll.row,view.bottom=Math.floor(view.yBottom/row.height),view.atEdge=!(view.top>0&&view.bottom<list.length-1),view.triggerZone=view.yTop<trigger.distance*row.height?EDGE_TOP:view.yBottom>(list.length-trigger.distance-1)*row.height?EDGE_BOTTOM:!1,view.triggerZoneChange=view.triggerZone!==_view.triggerZone,view.deadZone=view.yTop<row.height?EDGE_TOP:view.yBottom>(list.length-1)*row.height?EDGE_BOTTOM:!1,view.deadZoneChange=view.deadZone!==_view.deadZone,view.ytChange=view.top!==_view.top,view.ybChange=view.bottom!==_view.bottom}function setBufferToIndex(index){buffer.top=index,buffer.bottom=buffer.top+buffer.rows,validateBuffer()}function updateBufferModel(){var index=scroll.row,direction=scroll.direction,distance=buffer.distance;switch(direction){case SCROLL_UP:buffer.top=index-distance,buffer.bottom=index-distance+buffer.rows;break;case SCROLL_DOWN:buffer.top=index,buffer.bottom=index+buffer.rows;break;default:$log.warn("We only know how to deal with scrolling on the y axis for now")}validateBuffer()}function scrollingUp(start,distance){for(var p,x,y,itemsToMerge=list.slice(start*columns,start*columns+distance),r=start+distance/columns-1,i=itemsToMerge.length-1;i>=0;i--){p=getRelativeBufferPosition(start*columns+i),x=p%columns*(container.width/columns),y=r*row.height;var coords={x:x,y:y},index=start*columns+i;updateItem(p,itemsToMerge[i],coords,index),p%columns===0?r--:null}}function scrollingDown(start,distance){for(var p,x,y,itemsToMerge=list.slice(start*columns,start*columns+distance),r=start-1,i=0;i<itemsToMerge.length;i++){p=getRelativeBufferPosition(start*columns+i),p%columns===0?r++:null,x=p%columns*(container.width/columns),y=r*row.height;var coords={x:x,y:y},index=start*columns+i;updateItem(p,itemsToMerge[i],coords,index)}}function render(){var start,end,distance;if(isRenderRequired())if(buffer.reset||buffer.refresh){switch(start=buffer.top,end=buffer.bottom,distance=(end-start)*columns,scroll.direction){case SCROLL_UP:scrollingUp(start,distance);break;case SCROLL_DOWN:scrollingDown(start,distance)}scope.$digest()}else{switch(scroll.direction){case SCROLL_UP:start=buffer.top,end=_buffer.top,distance=Math.abs((end-start)*columns),scrollingUp(start,distance);break;case SCROLL_DOWN:start=_buffer.bottom,end=buffer.bottom,distance=Math.abs((end-start)*columns),scrollingDown(start,distance)}scope.$digest()}}function triggerEdge(){switch(view.triggerZone){case EDGE_TOP:triggerTop();break;case EDGE_BOTTOM:triggerBottom();break;default:$log.warn("Zone "+view.triggerZone+" is not supported")}}function triggerTop(){}function triggerBottom(){}function calculateDimensions(){calculateWrapper(),calculateBuffer()}function calculateContainer(){container.height=container.el.prop("clientHeight"),container.width=container.el.prop("clientWidth")}function calculateWrapper(){list&&(wrapper.rows=(list.length+list.length%columns)/columns,wrapper.height=wrapper.rows*row.height,wrapper.el.css("height",wrapper.height+"px"),iscroll.refresh())}function calculateBuffer(){view.rows=Math.ceil(container.height/row.height)+1,buffer.bottom=buffer.top+buffer.rows||buffer.top+BUFFER_ROWS*COLUMNS,buffer.yBottom=buffer.bottom*row.height||(buffer.top+BUFFER_ROWS*COLUMNS)*ROW_HEIGHT,buffer.distance=buffer.rows-view.rows>0?buffer.rows-view.rows:0,console.log("Calculating buffer",buffer.top,buffer.bottom,buffer.rows,buffer.size,view.rows,buffer.distance,container.height,row.height)}function cleanup(){$window.removeEventListener("statusTap"),container.el.off("scroll"),iscroll.destroy(),iscroll=null,elements.remove(),wrapper.el.remove(),container.el.remove(),delete container.el,delete wrapper.el,elements=null}var elements,_scroll,_view,_buffer,BUFFER_ROWS=10,COLUMNS=1,ROW_HEIGHT=40,ROW_WIDTH="100%",EDGE_TOP="top",EDGE_BOTTOM="bottom",SCROLL_UP="up",SCROLL_DOWN="down",TRIGGER_DISTANCE=5,list=[],items=[],itemName="item",container={height:0,width:0,el:undefined},wrapper={height:0,width:0,rows:0,el:undefined},row={height:ROW_HEIGHT,width:ROW_WIDTH},columns=COLUMNS,trigger={distance:TRIGGER_DISTANCE},scroll={x:0,xDelta:0,xIndex:0,xDistance:0,xChange:!1,y:0,yDelta:0,yDistance:0,yChange:!1,row:0,pointer:0,direction:SCROLL_DOWN,directionChange:!1},view={top:0,bottom:0,left:0,right:0,items:[],size:0,rows:0,yTop:0,yBottom:0,atEdge:EDGE_TOP,deadZone:EDGE_TOP,deadZoneChange:!1},buffer={rows:BUFFER_ROWS,size:BUFFER_ROWS*COLUMNS,items:[],elements:[],top:0,bottom:0,left:0,right:0,yTop:0,yBottom:0,atEdge:EDGE_TOP,pointer:0,distance:0,reset:!1,refresh:!1};container.el=element,wrapper.el=element.children();var iscroll=new IScroll(element[0],{useTransform:!0,useTransition:!1,HWCompositing:!1,probeType:3,mouseWheel:!0});initialise(scope,attributes),scope.deleteItem=function(index){scope.item=list.splice(index,1)[0],console.log("Deleting "+index,scope.item,buffer),buffer.atEdge===EDGE_BOTTOM&&(buffer.top--,buffer.bottom--),attributes.onDelete&&scope.$eval(attributes.onDelete+"(item)"),refresh()},scope.$watchCollection(attributes.list,function(newList){list=newList?newList:[],console.log("List changed",list.length),refresh()});var y,updating=!1;iscroll.on("scroll",function(){y=Math.abs(this.y),tick()}),scope.$on("$destroy",function(){cleanup()})}}}])}(window,window.angular);